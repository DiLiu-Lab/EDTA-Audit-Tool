name: EDTA Audit Script Demo

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  demo-basic-usage:
    name: "Demo 1: Basic Usage (No Organization)"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Verify script exists
        run: |
          ls -la
          if [ ! -f "edta_audit.sh" ]; then
            echo "ERROR: edta_audit.sh not found!"
            exit 1
          fi
      
      - name: Setup test environment
        run: |
          # Create proper directory structure for one good sample
          mkdir -p test_data/sample1/sample1.mod.EDTA.raw
          
          # Create library files with proper sizes
          dd if=/dev/zero of=test_data/sample1/sample1.mod.EDTA.raw/sample1.LTR.raw.fa bs=1K count=600
          dd if=/dev/zero of=test_data/sample1/sample1.mod.EDTA.raw/sample1.TIR.intact.raw.fa bs=1K count=120
          dd if=/dev/zero of=test_data/sample1/sample1.mod.EDTA.raw/sample1.LINE.raw.fa bs=1K count=40
          dd if=/dev/zero of=test_data/sample1/sample1.mod.EDTA.raw/sample1.Helitron.intact.raw.fa bs=1K count=60
          dd if=/dev/zero of=test_data/sample1/sample1.mod.EDTA.raw/sample1.SINE.raw.fa bs=1 count=600
          
          # Create summary and log
          echo "Total TE: 25.5%" > test_data/sample1/sample1.TEanno.sum
          echo "EDTA run complete" > test_data/sample1/run.log
          
          # Create scattered files (should cause errors in basic mode)
          mkdir -p test_data/sample2.mod.EDTA.raw
          dd if=/dev/zero of=test_data/sample2.mod.EDTA.raw/sample2.LTR.raw.fa bs=1K count=600
          echo "Total TE: 22.0%" > test_data/sample2.TEanno.sum
          
          echo "Test data structure:"
          ls -lR test_data/
      
      - name: Make script executable
        run: chmod +x edta_audit.sh
      
      - name: Run EDTA Audit - Basic Mode
        run: |
          echo "=========================================="
          echo "DEMO 1: Basic Usage (No -O flag)"
          echo "Expects: sample1 PASS, sample2 FAIL (scattered files)"
          echo "=========================================="
          ./edta_audit.sh -d test_data -t plant || echo "Script completed with errors (expected for scattered files)"
      
      - name: Display results
        run: |
          echo ""
          echo "=========================================="
          echo "FAILED SAMPLES (with reasons):"
          echo "=========================================="
          cat edta_failed_list.txt 2>/dev/null || echo "No failed list generated"
          echo ""
          echo "=========================================="
          echo "PASSED SAMPLES:"
          echo "=========================================="
          cat edta_passed_list.txt 2>/dev/null || echo "No passed list generated"
      
      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: demo1-results
          path: |
            edta_failed_list.txt
            edta_passed_list.txt

  demo-organize-mode:
    name: "Demo 2: With Organization (-O flag)"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup test environment with scattered files
        run: |
          # Create main sample directory
          mkdir -p test_data/genome1
          
          # Create scattered EDTA output directory (outside main dir)
          mkdir -p test_data/genome1.mod.EDTA.raw
          dd if=/dev/zero of=test_data/genome1.mod.EDTA.raw/genome1.LTR.raw.fa bs=1K count=600
          dd if=/dev/zero of=test_data/genome1.mod.EDTA.raw/genome1.TIR.intact.raw.fa bs=1K count=120
          dd if=/dev/zero of=test_data/genome1.mod.EDTA.raw/genome1.LINE.raw.fa bs=1K count=40
          dd if=/dev/zero of=test_data/genome1.mod.EDTA.raw/genome1.Helitron.intact.raw.fa bs=1K count=60
          dd if=/dev/zero of=test_data/genome1.mod.EDTA.raw/genome1.SINE.raw.fa bs=1 count=600
          
          # Create scattered summary file
          echo "Total TE: 25.5%" > test_data/genome1.TEanno.sum
          
          # Create log in proper directory
          echo "EDTA analysis complete" > test_data/genome1/run.log
          
          echo "=========================================="
          echo "Directory structure BEFORE organization:"
          echo "=========================================="
          ls -lR test_data/
      
      - name: Make script executable
        run: chmod +x edta_audit.sh
      
      - name: Run EDTA Audit - With Organization
        run: |
          echo ""
          echo "=========================================="
          echo "DEMO 2: With Organization (-O flag)"
          echo "This will merge scattered files into genome1/"
          echo "=========================================="
          ./edta_audit.sh -d test_data -t plant -O
      
      - name: Show organized structure
        run: |
          echo ""
          echo "=========================================="
          echo "Directory structure AFTER organization:"
          echo "=========================================="
          ls -lR test_data/
      
      - name: Display results
        run: |
          echo ""
          echo "=========================================="
          echo "FAILED SAMPLES:"
          echo "=========================================="
          cat edta_failed_list.txt 2>/dev/null || echo "None"
          echo ""
          echo "=========================================="
          echo "PASSED SAMPLES:"
          echo "=========================================="
          cat edta_passed_list.txt 2>/dev/null || echo "None"
      
      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: demo2-results
          path: |
            edta_failed_list.txt
            edta_passed_list.txt

  demo-move-samples:
    name: "Demo 3: Move Pass/Fail Samples (-m/-x flags)"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup test environment - Mixed quality samples
        run: |
          # PASSED sample (high TE%, all libraries present)
          mkdir -p test_data/good_genome/good_genome.mod.EDTA.raw
          dd if=/dev/zero of=test_data/good_genome/good_genome.mod.EDTA.raw/good_genome.LTR.raw.fa bs=1K count=600
          dd if=/dev/zero of=test_data/good_genome/good_genome.mod.EDTA.raw/good_genome.TIR.intact.raw.fa bs=1K count=120
          dd if=/dev/zero of=test_data/good_genome/good_genome.mod.EDTA.raw/good_genome.LINE.raw.fa bs=1K count=40
          dd if=/dev/zero of=test_data/good_genome/good_genome.mod.EDTA.raw/good_genome.Helitron.intact.raw.fa bs=1K count=60
          dd if=/dev/zero of=test_data/good_genome/good_genome.mod.EDTA.raw/good_genome.SINE.raw.fa bs=1 count=600
          echo "Total TE: 28.5%" > test_data/good_genome/good_genome.TEanno.sum
          echo "EDTA complete" > test_data/good_genome/run.log
          
          # FAILED sample (low TE%)
          mkdir -p test_data/poor_genome/poor_genome.mod.EDTA.raw
          dd if=/dev/zero of=test_data/poor_genome/poor_genome.mod.EDTA.raw/poor_genome.LTR.raw.fa bs=1K count=600
          dd if=/dev/zero of=test_data/poor_genome/poor_genome.mod.EDTA.raw/poor_genome.TIR.intact.raw.fa bs=1K count=120
          dd if=/dev/zero of=test_data/poor_genome/poor_genome.mod.EDTA.raw/poor_genome.LINE.raw.fa bs=1K count=40
          dd if=/dev/zero of=test_data/poor_genome/poor_genome.mod.EDTA.raw/poor_genome.Helitron.intact.raw.fa bs=1K count=60
          dd if=/dev/zero of=test_data/poor_genome/poor_genome.mod.EDTA.raw/poor_genome.SINE.raw.fa bs=1 count=600
          echo "Total TE: 5.2%" > test_data/poor_genome/poor_genome.TEanno.sum
          echo "EDTA complete" > test_data/poor_genome/run.log
          
          # FAILED sample (missing libraries)
          mkdir -p test_data/incomplete_genome/incomplete_genome.mod.EDTA.raw
          dd if=/dev/zero of=test_data/incomplete_genome/incomplete_genome.mod.EDTA.raw/incomplete_genome.LTR.raw.fa bs=1K count=600
          echo "Total TE: 22.0%" > test_data/incomplete_genome/incomplete_genome.TEanno.sum
          echo "EDTA complete" > test_data/incomplete_genome/run.log
          
          echo "=========================================="
          echo "Initial directory structure:"
          echo "=========================================="
          ls -la test_data/
      
      - name: Make script executable
        run: chmod +x edta_audit.sh
      
      - name: Run EDTA Audit - With Move Operations
        run: |
          echo ""
          echo "=========================================="
          echo "DEMO 3: Move Pass/Fail Samples"
          echo "Pass â†’ output/passed-edta_audit"
          echo "Fail â†’ output/failed-edta_audit"
          echo "=========================================="
          ./edta_audit.sh -d test_data -t plant -m output/passed -x output/failed
      
      - name: Display organized directories
        run: |
          echo ""
          echo "=========================================="
          echo "PASSED SAMPLES DIRECTORY:"
          echo "=========================================="
          ls -la output/passed-edta_audit/ 2>/dev/null || echo "No passed samples"
          
          echo ""
          echo "=========================================="
          echo "FAILED SAMPLES DIRECTORY:"
          echo "=========================================="
          ls -la output/failed-edta_audit/ 2>/dev/null || echo "No failed samples"
          
          echo ""
          echo "=========================================="
          echo "Original test_data (should be empty now):"
          echo "=========================================="
          ls -la test_data/
      
      - name: Display results summary
        run: |
          echo ""
          echo "=========================================="
          echo "SUMMARY REPORTS"
          echo "=========================================="
          echo ""
          echo "Failed samples with reasons:"
          cat edta_failed_list.txt 2>/dev/null || echo "No failures"
          echo ""
          echo "Passed samples:"
          cat edta_passed_list.txt 2>/dev/null || echo "No passes"
      
      - name: Upload results and moved directories
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: demo3-results
          path: |
            edta_failed_list.txt
            edta_passed_list.txt
            output/

  demo-combined:
    name: "Demo 4: All Features Combined (-O -m -x)"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup complex test environment
        run: |
          # Good sample with scattered files
          mkdir -p test_data/scattered_good
          mkdir -p test_data/scattered_good.mod.EDTA.raw
          dd if=/dev/zero of=test_data/scattered_good.mod.EDTA.raw/scattered_good.LTR.raw.fa bs=1K count=600
          dd if=/dev/zero of=test_data/scattered_good.mod.EDTA.raw/scattered_good.TIR.intact.raw.fa bs=1K count=120
          dd if=/dev/zero of=test_data/scattered_good.mod.EDTA.raw/scattered_good.LINE.raw.fa bs=1K count=40
          dd if=/dev/zero of=test_data/scattered_good.mod.EDTA.raw/scattered_good.Helitron.intact.raw.fa bs=1K count=60
          dd if=/dev/zero of=test_data/scattered_good.mod.EDTA.raw/scattered_good.SINE.raw.fa bs=1 count=600
          echo "Total TE: 30.1%" > test_data/scattered_good.TEanno.sum
          echo "EDTA complete" > test_data/scattered_good/run.log
          
          # Poor sample with scattered files
          mkdir -p test_data/scattered_poor
          mkdir -p test_data/scattered_poor.mod.EDTA.raw
          dd if=/dev/zero of=test_data/scattered_poor.mod.EDTA.raw/scattered_poor.LTR.raw.fa bs=1 count=100
          echo "Total TE: 2.5%" > test_data/scattered_poor.TEanno.sum
          echo "EDTA complete" > test_data/scattered_poor/run.log
          
          # Another good sample (no scattering)
          mkdir -p test_data/clean_good/clean_good.mod.EDTA.raw
          dd if=/dev/zero of=test_data/clean_good/clean_good.mod.EDTA.raw/clean_good.LTR.raw.fa bs=1K count=700
          dd if=/dev/zero of=test_data/clean_good/clean_good.mod.EDTA.raw/clean_good.TIR.intact.raw.fa bs=1K count=150
          dd if=/dev/zero of=test_data/clean_good/clean_good.mod.EDTA.raw/clean_good.LINE.raw.fa bs=1K count=50
          dd if=/dev/zero of=test_data/clean_good/clean_good.mod.EDTA.raw/clean_good.Helitron.intact.raw.fa bs=1K count=70
          dd if=/dev/zero of=test_data/clean_good/clean_good.mod.EDTA.raw/clean_good.SINE.raw.fa bs=1 count=700
          echo "Total TE: 35.8%" > test_data/clean_good/clean_good.TEanno.sum
          echo "EDTA complete" > test_data/clean_good/run.log
          
          echo "=========================================="
          echo "Directory structure BEFORE processing:"
          echo "=========================================="
          ls -lR test_data/
      
      - name: Make script executable
        run: chmod +x edta_audit.sh
      
      - name: Run EDTA Audit - All Features
        run: |
          echo ""
          echo "=========================================="
          echo "DEMO 4: Combined Features"
          echo "  -O: Organize scattered files first"
          echo "  -m: Move passed â†’ results/qc_passed"
          echo "  -x: Move failed â†’ results/qc_failed"
          echo "  -t: Plant mode (strict thresholds)"
          echo "=========================================="
          ./edta_audit.sh -d test_data -t plant -O -m results/qc_passed -x results/qc_failed
      
      - name: Display final organization
        run: |
          echo ""
          echo "=========================================="
          echo "FINAL DIRECTORY STRUCTURE"
          echo "=========================================="
          echo ""
          echo "âœ… QC PASSED samples:"
          ls -lR results/qc_passed-edta_audit/ 2>/dev/null || echo "None"
          echo ""
          echo "âŒ QC FAILED samples:"
          ls -lR results/qc_failed-edta_audit/ 2>/dev/null || echo "None"
          echo ""
          echo "ğŸ“ Original directory (should be empty):"
          ls -la test_data/ 2>/dev/null || echo "Directory removed (all moved)"
      
      - name: Display comprehensive report
        run: |
          echo ""
          echo "=========================================="
          echo "ğŸ“Š COMPREHENSIVE QC REPORT"
          echo "=========================================="
          echo ""
          echo "âŒ FAILED SAMPLES WITH DETAILED REASONS:"
          cat edta_failed_list.txt 2>/dev/null
          echo ""
          echo "âœ… PASSED SAMPLES:"
          cat edta_passed_list.txt 2>/dev/null
      
      - name: Upload all results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: demo4-combined-results
          path: |
            edta_failed_list.txt
            edta_passed_list.txt
            results/

  summary:
    name: "ğŸ“‹ Generate Demo Summary"
    runs-on: ubuntu-latest
    needs: [demo-basic-usage, demo-organize-mode, demo-move-samples, demo-combined]
    if: always()
    
    steps:
      - name: Create summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ğŸ§¬ EDTA Audit Script - Demo Summary
          
          ## âœ… Three Main Usage Scenarios Demonstrated:
          
          ### 1ï¸âƒ£ Basic Usage (No Organization)
          ```bash
          ./edta_audit.sh -d <input_directory> -t <type>
          ```
          - Reports errors for scattered files
          - Expects properly organized directory structure
          - Useful when EDTA output is already organized
          
          **Expected behavior**: Sample with scattered files will **FAIL** with error "RawDirMissing(Try -O)"
          
          ---
          
          ### 2ï¸âƒ£ With Organization (-O flag)
          ```bash
          ./edta_audit.sh -d <input_directory> -t <type> -O
          ```
          - **Automatically organizes scattered files**
          - Merges `*.mod.EDTA.raw`, `*.TEanno.sum` into proper directories
          - Then performs QC audit
          
          **Expected behavior**: Scattered files are merged, then properly audited
          
          ---
          
          ### 3ï¸âƒ£ Move Pass/Fail Samples (-m/-x flags)
          ```bash
          ./edta_audit.sh -d <input_directory> -t <type> -m <pass_dir> -x <fail_dir>
          ```
          - Moves **passed** samples to `<pass_dir>-edta_audit/`
          - Moves **failed** samples to `<fail_dir>-edta_audit/`
          - Organizes results automatically for easy downstream processing
          
          **Expected behavior**: Clean separation of QC pass/fail samples
          
          ---
          
          ### 4ï¸âƒ£ Combined Usage (All features)
          ```bash
          ./edta_audit.sh -d <input_directory> -t plant -O -m <pass_dir> -x <fail_dir>
          ```
          - **Complete workflow**: Organize â†’ Audit â†’ Separate
          - Recommended for production use
          
          ---
          
          ## ğŸŒ Species Modes Available:
          
          | Mode | Icon | TE% Min | LTR Min | LINE Min | Use Case |
          |------|------|---------|---------|----------|----------|
          | **plant** | ğŸŒ± | 20% | 500 KB | 30 KB | Strict (plant genomes) |
          | **animal** | ğŸ… | 5% | 10 KB | 50 KB | Standard (animal genomes) |
          | **fungi** | ğŸ„ | 1% | 5 KB | 1 KB | Permissive (fungal genomes) |
          | **other** | âš™ï¸ | 3% | 10 KB | 5 KB | General purpose |
          
          ---
          
          ## ğŸ“¦ Output Files:
          - `edta_passed_list.txt` - List of samples that passed QC
          - `edta_failed_list.txt` - List of failed samples **with reasons**
          
          ## ğŸ¯ Quality Checks Performed:
          1. âœ… TE percentage threshold
          2. âœ… LTR library size
          3. âœ… TIR library size
          4. âœ… LINE library size
          5. âœ… Helitron library size
          6. âœ… SINE library size
          EOF
