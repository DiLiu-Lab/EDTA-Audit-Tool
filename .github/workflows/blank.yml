name: Full Feature Demo (3 Scenarios)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ

jobs:
  run-comprehensive-demo:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: ðŸ› ï¸ Setup Environment
      run: |
        chmod +x edta_audit.sh
        echo "Script made executable."

    # ========================================================
    # åœºæ™¯ 1: é»˜è®¤æ¨¡å¼ (ä¸åšæ•´ç†ï¼Œé¢å¯¹æ•£ä¹±æ–‡ä»¶åº”æŠ¥é”™)
    # ========================================================
    - name: ðŸ§ª Scenario 1: Default Usage (Expect Fail on Messy Data)
      run: |
        echo "----------------------------------------------------"
        echo "Creating Messy Dataset #1 (Scattered files)..."
        mkdir -p Data_Scen1/Maize_Sample
        
        # åˆ¶é€ æ•£ä¹±æ–‡ä»¶ (Loose Files) - åœ¨æ ·æœ¬æ–‡ä»¶å¤¹å¤–
        echo "  Total TE: 45.00%" > Data_Scen1/Maize_Sample.TEanno.sum
        mkdir -p Data_Scen1/Maize_Sample.mod.EDTA.raw
        truncate -s 600K Data_Scen1/Maize_Sample.mod.EDTA.raw/Maize.LTR.raw.fa
        truncate -s 200K Data_Scen1/Maize_Sample.mod.EDTA.raw/Maize.TIR.intact.raw.fa
        truncate -s 100K Data_Scen1/Maize_Sample.mod.EDTA.raw/Maize.LINE.raw.fa
        truncate -s 100K Data_Scen1/Maize_Sample.mod.EDTA.raw/Maize.Helitron.intact.raw.fa
        truncate -s 1K   Data_Scen1/Maize_Sample.mod.EDTA.raw/Maize.SINE.raw.fa
        
        echo ">>> Running Command: ./edta_audit.sh -d Data_Scen1 -t plant"
        echo ">>> Expectation: ERROR (Because files are scattered and -O is OFF)"
        
        # åŠ ä¸Š || true é˜²æ­¢æŠ¥é”™å¯¼è‡´æ•´ä¸ªæµç¨‹ä¸­æ–­ï¼Œè®©æˆ‘ä»¬èƒ½ç»§ç»­çœ‹åŽé¢çš„æ¼”ç¤º
        ./edta_audit.sh -d Data_Scen1 -t plant || true

    # ========================================================
    # åœºæ™¯ 2: æ•´ç†æ¨¡å¼ (åŠ  -Oï¼Œè‡ªåŠ¨ä¿®å¤æ•£ä¹±æ–‡ä»¶å¹¶è¿è¡Œ)
    # ========================================================
    - name: âœ¨ Scenario 2: With -O Flag (Auto-Organize & Pass)
      run: |
        echo "----------------------------------------------------"
        echo "Creating Messy Dataset #2 (Same mess as above)..."
        mkdir -p Data_Scen2/Rice_Sample
        
        # åŒæ ·çš„æ•£ä¹±ç»“æž„
        echo "  Total TE: 35.00%" > Data_Scen2/Rice_Sample.TEanno.sum
        mkdir -p Data_Scen2/Rice_Sample.mod.EDTA.raw
        truncate -s 600K Data_Scen2/Rice_Sample.mod.EDTA.raw/Rice.LTR.raw.fa
        truncate -s 200K Data_Scen2/Rice_Sample.mod.EDTA.raw/Rice.TIR.intact.raw.fa
        truncate -s 100K Data_Scen2/Rice_Sample.mod.EDTA.raw/Rice.LINE.raw.fa
        truncate -s 100K Data_Scen2/Rice_Sample.mod.EDTA.raw/Rice.Helitron.intact.raw.fa
        truncate -s 1K   Data_Scen2/Rice_Sample.mod.EDTA.raw/Rice.SINE.raw.fa

        echo ">>> Running Command: ./edta_audit.sh -d Data_Scen2 -t plant -O"
        echo ">>> Expectation: SUCCESS (Files moved to folder, then Audit Pass)"
        
        ./edta_audit.sh -d Data_Scen2 -t plant -O

    # ========================================================
    # åœºæ™¯ 3: ç»¼åˆç®¡ç†æ¨¡å¼ (åŠ  -O -m -xï¼Œæ•´ç†+åˆ†ç±»ç§»åŠ¨)
    # ========================================================
    - name: ðŸ“¦ Scenario 3: Full Options (-O -m -x) (Sort Results)
      run: |
        echo "----------------------------------------------------"
        echo "Creating Mixed Dataset #3 (One Good, One Bad)..."
        mkdir -p Data_Scen3
        
        # æ ·æœ¬ A: å¥½æ•°æ® (æ•£ä¹±ï¼Œéœ€è¦ -O æ•´ç†ï¼Œä¸”æ•°æ®è¾¾æ ‡)
        mkdir -p Data_Scen3/Good_Sample
        echo "  Total TE: 55.00%" > Data_Scen3/Good_Sample.TEanno.sum
        mkdir -p Data_Scen3/Good_Sample.mod.EDTA.raw
        truncate -s 800K Data_Scen3/Good_Sample.mod.EDTA.raw/Good.LTR.raw.fa
        truncate -s 100K Data_Scen3/Good_Sample.mod.EDTA.raw/Good.LINE.raw.fa
        truncate -s 100K Data_Scen3/Good_Sample.mod.EDTA.raw/Good.Helitron.intact.raw.fa
        truncate -s 200K Data_Scen3/Good_Sample.mod.EDTA.raw/Good.TIR.intact.raw.fa
        truncate -s 1K   Data_Scen3/Good_Sample.mod.EDTA.raw/Good.SINE.raw.fa

        # æ ·æœ¬ B: åæ•°æ® (æ•°æ®å®Œæ•´ï¼Œä½† TE å«é‡å¤ªä½Žï¼Œåº”è¢«ç§»åŠ¨åˆ° Fail æ–‡ä»¶å¤¹)
        mkdir -p Data_Scen3/Bad_Sample
        # TE åªæœ‰ 2%ï¼Œä½ŽäºŽæ¤ç‰©è¦æ±‚çš„ 20%
        echo "  Total TE: 2.00%" > Data_Scen3/Bad_Sample/Bad.TEanno.sum 
        mkdir -p Data_Scen3/Bad_Sample/Bad.mod.EDTA.raw
        # ç”šè‡³è¿ž raw data éƒ½æ˜¯ç©ºçš„
        touch Data_Scen3/Bad_Sample/Bad.mod.EDTA.raw/empty.fa 

        echo ">>> Running Command: ./edta_audit.sh -d Data_Scen3 -t plant -O -m Final_Pass -x Final_Fail"
        echo ">>> Expectation: 'Good_Sample' moves to Final_Pass; 'Bad_Sample' moves to Final_Fail"
        
        ./edta_audit.sh -d Data_Scen3 -t plant -O -m Final_Pass -x Final_Fail

        echo -e "\nChecking Results Directory Structure:"
        ls -R Final_Pass
        ls -R Final_Fail
