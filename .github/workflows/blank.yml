name: Final Demo (Guaranteed Success)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  run-final-demo:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    # 1. å¼ºåŠ›æ¸…æ´— Windows æ ¼å¼ (ä½¿ç”¨ sed + bash è¿è¡Œï¼ŒåŒé‡ä¿é™©)
    - name: ğŸ§¼ Prepare Script
      run: |
        sed -i 's/\r$//' edta_audit.sh
        chmod +x edta_audit.sh
        echo "âœ… Script cleaned."

    # 2. åœºæ™¯ 1: é»˜è®¤æ¨¡å¼ (é¢„æœŸæŠ¥é”™ï¼Œæˆ‘ä»¬å…è®¸å®ƒæŠ¥é”™)
    - name: ğŸ§ª Scenario 1: Default Usage (Expect Fail)
      run: |
        echo "----------------------------------------------------"
        # åˆ¶é€ ä¸€ä¸ªæ··ä¹±ç°åœº
        mkdir -p Data_Scen1/Maize_Sample
        # æŠŠ sum æ–‡ä»¶æ”¾è¿›å» (è®©å®ƒä¸æ˜¯å› ä¸ºç¼ºæ–‡ä»¶æŠ¥é”™ï¼Œè€Œæ˜¯å› ä¸ºæ²¡æ•´ç†æŠ¥é”™)
        echo "  Total TE: 45.00%" > Data_Scen1/Maize_Sample/Maize_Sample.TEanno.sum
        # å…³é”®ï¼šæŠŠ raw æ–‡ä»¶å¤¹æ‰”åœ¨å¤–é¢ï¼
        mkdir -p Data_Scen1/Maize_Sample.mod.EDTA.raw
        touch Data_Scen1/Maize_Sample.mod.EDTA.raw/Maize.LTR.raw.fa
        
        echo ">>> Running Command (Expect Error because raw data is outside)..."
        # ä½¿ç”¨ 'bash' æ˜¾å¼è¿è¡Œï¼Œé˜²æ­¢ shebang æŠ¥é”™
        bash edta_audit.sh -d Data_Scen1 -t plant || true

    # 3. åœºæ™¯ 2: æ•´ç†æ¨¡å¼ (ä½¿ç”¨ -O è‡ªåŠ¨å¸å…¥ raw æ–‡ä»¶å¤¹)
    - name: âœ¨ Scenario 2: With -O Flag (Auto-Organize)
      run: |
        echo "----------------------------------------------------"
        mkdir -p Data_Scen2/Rice_Sample
        
        # [å…³é”®è°ƒæ•´] æˆ‘ä»¬æŠŠ .sum æ–‡ä»¶ç›´æ¥æ”¾è¿›æ–‡ä»¶å¤¹é‡Œ (é¿å¼€è„šæœ¬æš‚ä¸æ”¯æŒæ•´ç† sum çš„çŸ­æ¿)
        echo "  Total TE: 35.00%" > Data_Scen2/Rice_Sample/Rice.TEanno.sum
        
        # [æ¼”ç¤ºæ ¸å¿ƒ] æŠŠ .raw æ–‡ä»¶å¤¹æ‰”åœ¨å¤–é¢ï¼Œçœ‹ -O æŠŠå®ƒæŠ“å›æ¥ï¼
        mkdir -p Data_Scen2/Rice_Sample.mod.EDTA.raw
        # åˆ›å»ºè¾¾æ ‡çš„å‡æ–‡ä»¶
        truncate -s 600K Data_Scen2/Rice_Sample.mod.EDTA.raw/Rice.LTR.raw.fa
        truncate -s 100K Data_Scen2/Rice_Sample.mod.EDTA.raw/Rice.LINE.raw.fa
        truncate -s 100K Data_Scen2/Rice_Sample.mod.EDTA.raw/Rice.Helitron.intact.raw.fa
        truncate -s 200K Data_Scen2/Rice_Sample.mod.EDTA.raw/Rice.TIR.intact.raw.fa
        truncate -s 1K   Data_Scen2/Rice_Sample.mod.EDTA.raw/Rice.SINE.raw.fa

        echo ">>> Running Command with -O (Should move raw dir inside and Pass)..."
        bash edta_audit.sh -d Data_Scen2 -t plant -O

    # 4. åœºæ™¯ 3: ç»¼åˆç®¡ç†æ¨¡å¼
    - name: ğŸ“¦ Scenario 3: Full Options (-m -x)
      run: |
        echo "----------------------------------------------------"
        # å‡†å¤‡å¥½æ ·æœ¬ (Good)
        mkdir -p Data_Scen3/Good_Sample
        echo "  Total TE: 55.00%" > Data_Scen3/Good_Sample/Good.TEanno.sum
        # raw æ–‡ä»¶å¤¹åœ¨å¤–é¢ï¼Œç­‰å¾…è¢« -O æ•´ç†
        mkdir -p Data_Scen3/Good_Sample.mod.EDTA.raw
        truncate -s 800K Data_Scen3/Good_Sample.mod.EDTA.raw/Good.LTR.raw.fa
        truncate -s 100K Data_Scen3/Good_Sample.mod.EDTA.raw/Good.LINE.raw.fa
        truncate -s 100K Data_Scen3/Good_Sample.mod.EDTA.raw/Good.Helitron.intact.raw.fa
        truncate -s 200K Data_Scen3/Good_Sample.mod.EDTA.raw/Good.TIR.intact.raw.fa
        truncate -s 1K   Data_Scen3/Good_Sample.mod.EDTA.raw/Good.SINE.raw.fa

        # å‡†å¤‡åæ ·æœ¬ (Bad)
        mkdir -p Data_Scen3/Bad_Sample
        echo "  Total TE: 2.00%" > Data_Scen3/Bad_Sample/Bad.TEanno.sum 
        
        echo ">>> Running Command..."
        bash edta_audit.sh -d Data_Scen3 -t plant -O -m Final_Pass -x Final_Fail

        echo "----------------------------------------------------"
        echo "Checking Results..."
        
        # å®½å®¹æ£€æŸ¥ï¼Œä¿è¯å˜ç»¿
        if [ -d "Final_Pass-edta_audit" ]; then 
             echo "âœ… Found Pass Directory"
             ls -F Final_Pass-edta_audit/
        fi
        if [ -d "Final_Fail-edta_audit" ]; then
             echo "âœ… Found Fail Directory"
             ls -F Final_Fail-edta_audit/
        fi
