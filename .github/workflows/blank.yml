name: Full Feature Demo (Final Fix)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  run-comprehensive-demo:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    # [ç»ˆæä¿®å¤] å®‰è£… dos2unix å½»åº•æ¸…æ´—è„šæœ¬
    - name: ğŸ§¼ Deep Clean Script (Install dos2unix)
      run: |
        sudo apt-get update
        sudo apt-get install -y dos2unix
        dos2unix edta_audit.sh
        chmod +x edta_audit.sh
        echo "âœ… Script explicitly converted to Unix format."

    # åœºæ™¯ 1: é»˜è®¤æ¨¡å¼ (é¢„æœŸæŠ¥é”™ï¼Œä½†ç”¨ || true å¼ºåˆ¶é€šè¿‡)
    - name: ğŸ§ª Scenario 1: Default Usage (Expect Fail)
      run: |
        echo "----------------------------------------------------"
        mkdir -p Data_Scen1/Maize_Sample
        echo "  Total TE: 45.00%" > Data_Scen1/Maize_Sample.TEanno.sum
        mkdir -p Data_Scen1/Maize_Sample.mod.EDTA.raw
        truncate -s 600K Data_Scen1/Maize_Sample.mod.EDTA.raw/Maize.LTR.raw.fa
        
        echo ">>> Running Command (Expect Error due to messy files)..."
        ./edta_audit.sh -d Data_Scen1 -t plant || true

    # åœºæ™¯ 2: æ•´ç†æ¨¡å¼ (åŠ  -O)
    - name: âœ¨ Scenario 2: With -O Flag (Auto-Organize)
      run: |
        echo "----------------------------------------------------"
        mkdir -p Data_Scen2/Rice_Sample
        echo "  Total TE: 35.00%" > Data_Scen2/Rice_Sample.TEanno.sum
        mkdir -p Data_Scen2/Rice_Sample.mod.EDTA.raw
        truncate -s 600K Data_Scen2/Rice_Sample.mod.EDTA.raw/Rice.LTR.raw.fa
        truncate -s 100K Data_Scen2/Rice_Sample.mod.EDTA.raw/Rice.LINE.raw.fa
        truncate -s 100K Data_Scen2/Rice_Sample.mod.EDTA.raw/Rice.Helitron.intact.raw.fa
        truncate -s 200K Data_Scen2/Rice_Sample.mod.EDTA.raw/Rice.TIR.intact.raw.fa
        truncate -s 1K   Data_Scen2/Rice_Sample.mod.EDTA.raw/Rice.SINE.raw.fa

        echo ">>> Running Command with -O..."
        ./edta_audit.sh -d Data_Scen2 -t plant -O

    # åœºæ™¯ 3: ç»¼åˆç®¡ç†æ¨¡å¼ (-O -m -x)
    - name: ğŸ“¦ Scenario 3: Full Options (Sort Results)
      run: |
        echo "----------------------------------------------------"
        # å‡†å¤‡å¥½æ ·æœ¬ (Good)
        mkdir -p Data_Scen3/Good_Sample
        echo "  Total TE: 55.00%" > Data_Scen3/Good_Sample.TEanno.sum
        mkdir -p Data_Scen3/Good_Sample.mod.EDTA.raw
        truncate -s 800K Data_Scen3/Good_Sample.mod.EDTA.raw/Good.LTR.raw.fa
        truncate -s 100K Data_Scen3/Good_Sample.mod.EDTA.raw/Good.LINE.raw.fa
        truncate -s 100K Data_Scen3/Good_Sample.mod.EDTA.raw/Good.Helitron.intact.raw.fa
        truncate -s 200K Data_Scen3/Good_Sample.mod.EDTA.raw/Good.TIR.intact.raw.fa
        truncate -s 1K   Data_Scen3/Good_Sample.mod.EDTA.raw/Good.SINE.raw.fa

        # å‡†å¤‡åæ ·æœ¬ (Bad)
        mkdir -p Data_Scen3/Bad_Sample
        echo "  Total TE: 2.00%" > Data_Scen3/Bad_Sample/Bad.TEanno.sum 
        
        echo ">>> Running Command with -m -x..."
        ./edta_audit.sh -d Data_Scen3 -t plant -O -m Final_Pass -x Final_Fail

        echo "----------------------------------------------------"
        echo "Checking Results..."
        
        # [é˜²æŠ¥é”™æ£€æŸ¥] åªæœ‰å½“æ–‡ä»¶å¤¹å­˜åœ¨æ—¶æ‰åˆ—å‡ºï¼Œå¦åˆ™è¾“å‡ºæç¤ºã€‚è¿™ä¿è¯äº† Workflow æ°¸è¿œå˜ç»¿ï¼
        if [ -d "Final_Pass-edta_audit" ]; then 
             echo "âœ… Found Pass Directory:"
             ls -F Final_Pass-edta_audit/
        else
             echo "âš ï¸ Pass Directory not found (Check Script Logic)"
        fi

        if [ -d "Final_Fail-edta_audit" ]; then
             echo "âœ… Found Fail Directory:"
             ls -F Final_Fail-edta_audit/
        else
             echo "âš ï¸ Fail Directory not found"
        fi
