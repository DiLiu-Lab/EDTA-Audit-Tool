name: Final Demo (Strict Filename Match)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  run-demo:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    # 1. å½»åº•æ¸…æ´— Windows æ ¼å¼ (ä½¿ç”¨ dos2unix æ˜¯æœ€ä¿é™©çš„)
    - name: ğŸ§¼ Fix Windows Line Endings
      run: |
        sudo apt-get update
        sudo apt-get install -y dos2unix
        dos2unix edta_audit.sh
        chmod +x edta_audit.sh
        echo "âœ… Script converted to Unix format."

    # 2. åœºæ™¯ 1: é»˜è®¤æ¨¡å¼ (é¢„æœŸæŠ¥é”™)
    - name: ğŸ§ª Scenario 1: Default Usage (Expect Fail)
      run: |
        echo "----------------------------------------------------"
        mkdir -p Data_Scen1/Maize_Genomic
        
        # [æ•…æ„åˆ¶é€ ] æ•£è½åœ¨å¤–çš„æ–‡ä»¶
        # æ–‡ä»¶åè™½ç„¶è§„èŒƒï¼Œä½†å› ä¸ºæˆ‘ä»¬æ•…æ„ä¸åŠ  -O å‚æ•°ï¼Œè„šæœ¬ä¸ä¼šå»æ•´ç†å®ƒï¼Œæ‰€ä»¥é¢„æœŸä¼šæŠ¥é”™
        echo "  Total TE: 45.00%" > Data_Scen1/Maize_Genomic.fna.mod.EDTA.TEanno.sum
        
        echo ">>> Running Command (Expect Error)..."
        # åŠ ä¸Š || trueï¼Œå°±ç®—è„šæœ¬æŠ¥é”™ï¼ŒGitHub Action ä¹Ÿä¼šæ˜¾ç¤ºç»¿è‰²å¯¹å‹¾
        ./edta_audit.sh -d Data_Scen1 -t plant || true

    # 3. åœºæ™¯ 2: æ•´ç†æ¨¡å¼ (åŠ  -O)
    - name: âœ¨ Scenario 2: With -O Flag (Auto-Organize)
      run: |
        echo "----------------------------------------------------"
        # åˆ›å»ºä¸»æ–‡ä»¶å¤¹: Rice_Genomic
        mkdir -p Data_Scen2/Rice_Genomic
        
        # [å…³é”®ä¿®æ­£] æ–‡ä»¶åå¿…é¡»åŒ…å« .EDTA. æ‰èƒ½è¢«æ‚¨çš„è„šæœ¬ find å‘½ä»¤è¯†åˆ«ï¼
        # æ‚¨çš„è„šæœ¬é€»è¾‘ï¼šbasename%%.fna* -> å¾—åˆ° Rice_Genomic -> æˆåŠŸåŒ¹é…æ–‡ä»¶å¤¹
        echo "  Total TE: 35.00%" > Data_Scen2/Rice_Genomic.fna.mod.EDTA.TEanno.sum
        
        # åˆ›å»ºæ•£ä¹±çš„ raw æ–‡ä»¶å¤¹ (åå­—ä¹Ÿå¿…é¡»åŒ…å« .EDTA.)
        mkdir -p Data_Scen2/Rice_Genomic.fna.mod.EDTA.raw
        truncate -s 600K Data_Scen2/Rice_Genomic.fna.mod.EDTA.raw/Rice.LTR.raw.fa
        truncate -s 100K Data_Scen2/Rice_Genomic.fna.mod.EDTA.raw/Rice.LINE.raw.fa
        truncate -s 100K Data_Scen2/Rice_Genomic.fna.mod.EDTA.raw/Rice.Helitron.intact.raw.fa
        truncate -s 200K Data_Scen2/Rice_Genomic.fna.mod.EDTA.raw/Rice.TIR.intact.raw.fa
        truncate -s 1K   Data_Scen2/Rice_Genomic.fna.mod.EDTA.raw/Rice.SINE.raw.fa

        echo ">>> Running Command with -O (Should Move Files & Pass)..."
        ./edta_audit.sh -d Data_Scen2 -t plant -O

    # 4. åœºæ™¯ 3: ç»¼åˆç®¡ç†æ¨¡å¼ (-O -m -x)
    - name: ğŸ“¦ Scenario 3: Full Options (Sort Results)
      run: |
        echo "----------------------------------------------------"
        # --- æ ·æœ¬ A (Good) ---
        mkdir -p Data_Scen3/Good_Genomic
        # åŒæ ·ä½¿ç”¨è§„èŒƒçš„é•¿æ–‡ä»¶å
        echo "  Total TE: 55.00%" > Data_Scen3/Good_Genomic.fna.mod.EDTA.TEanno.sum
        mkdir -p Data_Scen3/Good_Genomic.fna.mod.EDTA.raw
        truncate -s 800K Data_Scen3/Good_Genomic.fna.mod.EDTA.raw/Good.LTR.raw.fa
        truncate -s 100K Data_Scen3/Good_Genomic.fna.mod.EDTA.raw/Good.LINE.raw.fa
        truncate -s 100K Data_Scen3/Good_Genomic.fna.mod.EDTA.raw/Good.Helitron.intact.raw.fa
        truncate -s 200K Data_Scen3/Good_Genomic.fna.mod.EDTA.raw/Good.TIR.intact.raw.fa
        truncate -s 1K   Data_Scen3/Good_Genomic.fna.mod.EDTA.raw/Good.SINE.raw.fa

        # --- æ ·æœ¬ B (Bad) ---
        mkdir -p Data_Scen3/Bad_Genomic
        # TE å«é‡å¤ªä½ (2%)ï¼Œç›´æ¥æ”¾å…¥æ–‡ä»¶å¤¹ï¼Œç¡®ä¿å®ƒæ˜¯å› æ•°å€¼ä½è€Œ Failï¼Œè€Œä¸æ˜¯å› æ–‡ä»¶ç¼ºå¤±
        echo "  Total TE: 2.00%" > Data_Scen3/Bad_Genomic/Bad_Genomic.TEanno.sum 
        
        echo ">>> Running Command with -m -x..."
        ./edta_audit.sh -d Data_Scen3 -t plant -O -m Final_Pass -x Final_Fail

        echo "----------------------------------------------------"
        echo "Checking Results..."
        
        # éªŒè¯ç»“æœæ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨
        if [ -d "Final_Pass-edta_audit" ]; then 
             echo "âœ… Found Pass Directory"
             ls -F Final_Pass-edta_audit/
        fi
        if [ -d "Final_Fail-edta_audit" ]; then
             echo "âœ… Found Fail Directory"
             ls -F Final_Fail-edta_audit/
        fi
