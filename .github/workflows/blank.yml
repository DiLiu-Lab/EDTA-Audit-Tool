name: EDTA Audit Script Demo

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allows manual triggering

jobs:
  demo-basic-usage:
    name: "Demo 1: Basic Usage (No Organization)"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup test environment
        run: |
          mkdir -p test_data/sample1
          mkdir -p test_data/sample2
          # Create scattered files (simulating messy EDTA output)
          touch test_data/sample1.mod.EDTA.raw/sample1.LTR.raw.fa
          touch test_data/sample1.mod.EDTA.raw/sample1.TIR.intact.raw.fa
          touch test_data/GC1_sample1.mod
          echo "Total TE: 25.5%" > test_data/sample1/sample1.TEanno.sum
          echo "EDTA run" > test_data/sample1/run.log
      
      - name: Make script executable
        run: chmod +x edta_audit.sh
      
      - name: Run EDTA Audit - Basic Mode
        run: |
          echo "=========================================="
          echo "DEMO 1: Basic Usage (Will report errors for scattered files)"
          echo "=========================================="
          ./edta_audit.sh -d test_data -t plant
        continue-on-error: true
      
      - name: Display results
        run: |
          echo "Failed samples:"
          cat edta_failed_list.txt || echo "No failed list generated"
          echo ""
          echo "Passed samples:"
          cat edta_passed_list.txt || echo "No passed list generated"
      
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: demo1-results
          path: |
            edta_failed_list.txt
            edta_passed_list.txt

  demo-organize-mode:
    name: "Demo 2: With Organization (-O flag)"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup test environment with scattered files
        run: |
          # Create main sample directories
          mkdir -p test_data/genome1
          mkdir -p test_data/genome2
          
          # Create scattered EDTA output files/dirs (simulating real messy output)
          mkdir -p test_data/genome1.mod.EDTA.raw
          dd if=/dev/zero of=test_data/genome1.mod.EDTA.raw/genome1.LTR.raw.fa bs=1K count=600
          dd if=/dev/zero of=test_data/genome1.mod.EDTA.raw/genome1.TIR.intact.raw.fa bs=1K count=120
          dd if=/dev/zero of=test_data/genome1.mod.EDTA.raw/genome1.LINE.raw.fa bs=1K count=40
          dd if=/dev/zero of=test_data/genome1.mod.EDTA.raw/genome1.Helitron.intact.raw.fa bs=1K count=60
          dd if=/dev/zero of=test_data/genome1.mod.EDTA.raw/genome1.SINE.raw.fa bs=1 count=600
          
          # Create summary file
          echo "Total TE: 25.5%" > test_data/genome1.TEanno.sum
          echo "EDTA analysis complete" > test_data/genome1/run.log
          
          # Show directory structure before organization
          echo "Directory structure BEFORE organization:"
          ls -lR test_data/
      
      - name: Make script executable
        run: chmod +x edta_audit.sh
      
      - name: Run EDTA Audit - With Organization
        run: |
          echo "=========================================="
          echo "DEMO 2: With Organization (-O flag)"
          echo "This will merge scattered files into proper directories"
          echo "=========================================="
          ./edta_audit.sh -d test_data -t plant -O
      
      - name: Show organized structure
        run: |
          echo ""
          echo "Directory structure AFTER organization:"
          ls -lR test_data/
      
      - name: Display results
        run: |
          echo ""
          echo "Failed samples:"
          cat edta_failed_list.txt || echo "No failures"
          echo ""
          echo "Passed samples:"
          cat edta_passed_list.txt || echo "No passes"
      
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: demo2-results
          path: |
            edta_failed_list.txt
            edta_passed_list.txt

  demo-move-samples:
    name: "Demo 3: Move Pass/Fail Samples (-m/-x flags)"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup test environment - Mixed quality samples
        run: |
          # Create PASSED sample (high TE%, all libraries present)
          mkdir -p test_data/good_genome/good_genome.mod.EDTA.raw
          dd if=/dev/zero of=test_data/good_genome/good_genome.mod.EDTA.raw/good_genome.LTR.raw.fa bs=1K count=600
          dd if=/dev/zero of=test_data/good_genome/good_genome.mod.EDTA.raw/good_genome.TIR.intact.raw.fa bs=1K count=120
          dd if=/dev/zero of=test_data/good_genome/good_genome.mod.EDTA.raw/good_genome.LINE.raw.fa bs=1K count=40
          dd if=/dev/zero of=test_data/good_genome/good_genome.mod.EDTA.raw/good_genome.Helitron.intact.raw.fa bs=1K count=60
          dd if=/dev/zero of=test_data/good_genome/good_genome.mod.EDTA.raw/good_genome.SINE.raw.fa bs=1 count=600
          echo "Total TE: 28.5%" > test_data/good_genome/good_genome.TEanno.sum
          echo "EDTA complete" > test_data/good_genome/run.log
          
          # Create FAILED sample (low TE%)
          mkdir -p test_data/poor_genome/poor_genome.mod.EDTA.raw
          dd if=/dev/zero of=test_data/poor_genome/poor_genome.mod.EDTA.raw/poor_genome.LTR.raw.fa bs=1K count=600
          dd if=/dev/zero of=test_data/poor_genome/poor_genome.mod.EDTA.raw/poor_genome.TIR.intact.raw.fa bs=1K count=120
          dd if=/dev/zero of=test_data/poor_genome/poor_genome.mod.EDTA.raw/poor_genome.LINE.raw.fa bs=1K count=40
          dd if=/dev/zero of=test_data/poor_genome/poor_genome.mod.EDTA.raw/poor_genome.Helitron.intact.raw.fa bs=1K count=60
          dd if=/dev/zero of=test_data/poor_genome/poor_genome.mod.EDTA.raw/poor_genome.SINE.raw.fa bs=1 count=600
          echo "Total TE: 5.2%" > test_data/poor_genome/poor_genome.TEanno.sum
          echo "EDTA complete" > test_data/poor_genome/run.log
          
          # Create FAILED sample (missing libraries)
          mkdir -p test_data/incomplete_genome/incomplete_genome.mod.EDTA.raw
          dd if=/dev/zero of=test_data/incomplete_genome/incomplete_genome.mod.EDTA.raw/incomplete_genome.LTR.raw.fa bs=1K count=600
          echo "Total TE: 22.0%" > test_data/incomplete_genome/incomplete_genome.TEanno.sum
          echo "EDTA complete" > test_data/incomplete_genome/run.log
          
          echo "Initial directory structure:"
          ls -la test_data/
      
      - name: Make script executable
        run: chmod +x edta_audit.sh
      
      - name: Run EDTA Audit - With Move Operations
        run: |
          echo "=========================================="
          echo "DEMO 3: Move Pass/Fail Samples"
          echo "Pass samples -> output/passed-edta_audit"
          echo "Fail samples -> output/failed-edta_audit"
          echo "=========================================="
          ./edta_audit.sh -d test_data -t plant -m output/passed -x output/failed
      
      - name: Display organized directories
        run: |
          echo ""
          echo "=========================================="
          echo "PASSED samples directory:"
          echo "=========================================="
          ls -la output/passed-edta_audit/ || echo "No passed samples"
          
          echo ""
          echo "=========================================="
          echo "FAILED samples directory:"
          echo "=========================================="
          ls -la output/failed-edta_audit/ || echo "No failed samples"
          
          echo ""
          echo "Original test_data directory (should be mostly empty):"
          ls -la test_data/
      
      - name: Display results summary
        run: |
          echo ""
          echo "=========================================="
          echo "SUMMARY REPORTS"
          echo "=========================================="
          echo ""
          echo "Failed samples with reasons:"
          cat edta_failed_list.txt || echo "No failures"
          echo ""
          echo "Passed samples:"
          cat edta_passed_list.txt || echo "No passes"
      
      - name: Upload results and moved directories
        uses: actions/upload-artifact@v4
        with:
          name: demo3-results
          path: |
            edta_failed_list.txt
            edta_passed_list.txt
            output/

  demo-combined:
    name: "Demo 4: All Features Combined (-O -m -x)"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup complex test environment
        run: |
          # Good sample with scattered files
          mkdir -p test_data/scattered_good
          mkdir -p test_data/scattered_good.mod.EDTA.raw
          dd if=/dev/zero of=test_data/scattered_good.mod.EDTA.raw/scattered_good.LTR.raw.fa bs=1K count=600
          dd if=/dev/zero of=test_data/scattered_good.mod.EDTA.raw/scattered_good.TIR.intact.raw.fa bs=1K count=120
          dd if=/dev/zero of=test_data/scattered_good.mod.EDTA.raw/scattered_good.LINE.raw.fa bs=1K count=40
          dd if=/dev/zero of=test_data/scattered_good.mod.EDTA.raw/scattered_good.Helitron.intact.raw.fa bs=1K count=60
          dd if=/dev/zero of=test_data/scattered_good.mod.EDTA.raw/scattered_good.SINE.raw.fa bs=1 count=600
          echo "Total TE: 30.1%" > test_data/scattered_good.TEanno.sum
          echo "EDTA complete" > test_data/scattered_good/run.log
          
          # Poor sample with scattered files
          mkdir -p test_data/scattered_poor
          mkdir -p test_data/scattered_poor.mod.EDTA.raw
          dd if=/dev/zero of=test_data/scattered_poor.mod.EDTA.raw/scattered_poor.LTR.raw.fa bs=1 count=100
          echo "Total TE: 2.5%" > test_data/scattered_poor.TEanno.sum
          echo "EDTA complete" > test_data/scattered_poor/run.log
          
          echo "Directory structure BEFORE processing:"
          ls -lR test_data/
      
      - name: Make script executable
        run: chmod +x edta_audit.sh
      
      - name: Run EDTA Audit - All Features
        run: |
          echo "=========================================="
          echo "DEMO 4: Combined Features"
          echo "  -O: Organize scattered files"
          echo "  -m: Move passed to results/qc_passed"
          echo "  -x: Move failed to results/qc_failed"
          echo "  -t: Plant mode (strict thresholds)"
          echo "=========================================="
          ./edta_audit.sh -d test_data -t plant -O -m results/qc_passed -x results/qc_failed
      
      - name: Display final organization
        run: |
          echo ""
          echo "=========================================="
          echo "FINAL DIRECTORY STRUCTURE"
          echo "=========================================="
          echo ""
          echo "QC PASSED samples:"
          ls -lR results/qc_passed-edta_audit/ || echo "None"
          echo ""
          echo "QC FAILED samples:"
          ls -lR results/qc_failed-edta_audit/ || echo "None"
          echo ""
          echo "Original directory (should be empty):"
          ls -la test_data/
      
      - name: Display comprehensive report
        run: |
          echo ""
          echo "=========================================="
          echo "COMPREHENSIVE QC REPORT"
          echo "=========================================="
          echo ""
          echo "FAILED SAMPLES WITH DETAILED REASONS:"
          cat edta_failed_list.txt
          echo ""
          echo "PASSED SAMPLES:"
          cat edta_passed_list.txt
      
      - name: Upload all results
        uses: actions/upload-artifact@v4
        with:
          name: demo4-combined-results
          path: |
            edta_failed_list.txt
            edta_passed_list.txt
            results/

  summary:
    name: "Generate Demo Summary"
    runs-on: ubuntu-latest
    needs: [demo-basic-usage, demo-organize-mode, demo-move-samples, demo-combined]
    if: always()
    
    steps:
      - name: Create summary
        run: |
          echo "# EDTA Audit Script - Demo Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Three Main Usage Scenarios Demonstrated:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 1ï¸âƒ£ Basic Usage (No Organization)" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo './edta_audit.sh -d <input_directory> -t <type>' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "- Reports errors for scattered files" >> $GITHUB_STEP_SUMMARY
          echo "- Expects properly organized directory structure" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 2ï¸âƒ£ With Organization (-O flag)" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo './edta_audit.sh -d <input_directory> -t <type> -O' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "- Automatically organizes scattered files" >> $GITHUB_STEP_SUMMARY
          echo "- Merges files into proper directory structure" >> $GITHUB_STEP_SUMMARY
          echo "- Then performs QC audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 3ï¸âƒ£ Move Pass/Fail Samples (-m/-x flags)" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo './edta_audit.sh -d <input_directory> -t <type> -m <pass_dir> -x <fail_dir>' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "- Moves passed samples to specified directory" >> $GITHUB_STEP_SUMMARY
          echo "- Moves failed samples to specified directory" >> $GITHUB_STEP_SUMMARY
          echo "- Organizes results automatically" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 4ï¸âƒ£ Combined Usage (All features)" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo './edta_audit.sh -d <input_directory> -t plant -O -m <pass_dir> -x <fail_dir>' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "- Combines all features for complete workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Species Modes Available:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ± **plant**: Strict thresholds (20% TE minimum)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ… **animal**: Standard thresholds (5% TE minimum)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ„ **fungi**: Permissive thresholds (1% TE minimum)" >> $GITHUB_STEP_SUMMARY
          echo "- âš™ï¸ **other**: General mode (3% TE minimum)" >> $GITHUB_STEP_SUMMARY
